<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>取年月日 | 蓝今项目跟踪</title>
    <meta name="description" content="问题记录">
    <link rel="icon" href="/leyuan/logo.png">
  <link rel="manifest" href="/leyuan/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/leyuan/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/leyuan/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/leyuan/assets/css/0.styles.3874f85f.css" as="style"><link rel="preload" href="/leyuan/assets/js/app.4c451c14.js" as="script"><link rel="preload" href="/leyuan/assets/js/3.4ae3e493.js" as="script"><link rel="preload" href="/leyuan/assets/js/22.39c1fc57.js" as="script"><link rel="prefetch" href="/leyuan/assets/js/10.8eefb424.js"><link rel="prefetch" href="/leyuan/assets/js/11.68aab707.js"><link rel="prefetch" href="/leyuan/assets/js/12.95bb57a6.js"><link rel="prefetch" href="/leyuan/assets/js/13.b3bf8474.js"><link rel="prefetch" href="/leyuan/assets/js/14.df8982b1.js"><link rel="prefetch" href="/leyuan/assets/js/15.106501c7.js"><link rel="prefetch" href="/leyuan/assets/js/16.0f836c92.js"><link rel="prefetch" href="/leyuan/assets/js/17.bb2516b8.js"><link rel="prefetch" href="/leyuan/assets/js/18.f368b757.js"><link rel="prefetch" href="/leyuan/assets/js/19.b69c04ec.js"><link rel="prefetch" href="/leyuan/assets/js/20.2ac64f3f.js"><link rel="prefetch" href="/leyuan/assets/js/21.e40b0aff.js"><link rel="prefetch" href="/leyuan/assets/js/23.c4555c15.js"><link rel="prefetch" href="/leyuan/assets/js/24.e5f849e5.js"><link rel="prefetch" href="/leyuan/assets/js/4.fdf1ba8a.js"><link rel="prefetch" href="/leyuan/assets/js/5.1ca93c25.js"><link rel="prefetch" href="/leyuan/assets/js/6.5c381795.js"><link rel="prefetch" href="/leyuan/assets/js/7.6005ada6.js"><link rel="prefetch" href="/leyuan/assets/js/8.3ae26f16.js"><link rel="prefetch" href="/leyuan/assets/js/9.60ee7dd4.js"><link rel="prefetch" href="/leyuan/assets/js/vendors~notification.94eb77ef.js">
    <link rel="stylesheet" href="/leyuan/assets/css/0.styles.3874f85f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/leyuan/" class="home-link router-link-active"><!----> <span class="site-name">蓝今项目跟踪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/leyuan/zh/inside/" class="nav-link router-link-active">内部</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">对外</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/leyuan/zh/customer/leyuan/leyuan.html" class="nav-link">徐州乐园</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/leyuan/zh/inside/" class="nav-link router-link-active">内部</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">对外</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/leyuan/zh/customer/leyuan/leyuan.html" class="nav-link">徐州乐园</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MES</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/env.html" class="sidebar-link">环境搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/env.html#需要文件" class="sidebar-link">需要文件</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>徐州乐园</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/leyuan.html" class="sidebar-link">APP &amp; BS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#表" class="sidebar-link">表</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#存储过程" class="sidebar-link">存储过程</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#服务端返回图片的路径" class="sidebar-link">服务端返回图片的路径</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#由于扩展配置问题而无法提供您的请求页面" class="sidebar-link">由于扩展配置问题而无法提供您的请求页面</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#关键字" class="sidebar-link">关键字</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#细表有使用-字段名-字段名-，这种配置方式的，细表主键必须显示" class="sidebar-link">细表有使用 &quot;字段名|字段名&quot;，这种配置方式的，细表主键必须显示</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#修改title" class="sidebar-link">修改title</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#登录标题" class="sidebar-link">登录标题</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#pps表单定义" class="sidebar-link">PPS表单定义</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#选择乐园用户" class="sidebar-link">选择乐园用户</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#弹出用户编号" class="sidebar-link">弹出用户编号</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#业务查询条件" class="sidebar-link">业务查询条件</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#所有表园区编号默认值" class="sidebar-link">所有表园区编号默认值</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#图片上传" class="sidebar-link">图片上传</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#虚拟目录" class="sidebar-link">虚拟目录</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#维保计划" class="sidebar-link">维保计划</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#日计算" class="sidebar-link">日计算</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#签名图片位置" class="sidebar-link">签名图片位置</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#首页保养" class="sidebar-link">首页保养</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#图片查看" class="sidebar-link">图片查看</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#维修图片" class="sidebar-link">维修图片</a></li></ul></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/leyuan.html#如果周保重复查看下维保计划" class="sidebar-link">如果周保重复查看下维保计划</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/fesion.html" class="sidebar-link">飞讯软件配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#数据库" class="sidebar-link">数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#函数" class="sidebar-link">函数</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#存储过程" class="sidebar-link">存储过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#app-配置" class="sidebar-link">APP 配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#内置函数、变量" class="sidebar-link">内置函数、变量</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#新单号" class="sidebar-link">新单号</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#推送" class="sidebar-link">推送</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#上拉加载-bindscroll" class="sidebar-link">上拉加载:bindscroll</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#图片上传" class="sidebar-link">图片上传</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#请求服务" class="sidebar-link">请求服务</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#下拉刷新" class="sidebar-link">下拉刷新</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#上传图片" class="sidebar-link">上传图片</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#头部" class="sidebar-link">头部</a></li></ul></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#cs-配置" class="sidebar-link">CS 配置</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#bs-配置" class="sidebar-link">BS 配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#菜单初始化" class="sidebar-link">菜单初始化</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#弹出框高度" class="sidebar-link">弹出框高度</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#字段多选" class="sidebar-link">字段多选</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#分割线" class="sidebar-link">分割线</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#首页图标显示不正常" class="sidebar-link">首页图标显示不正常</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#调用app" class="sidebar-link">调用app</a></li></ul></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#重算库存" class="sidebar-link">重算库存</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#库存结账" class="sidebar-link">库存结账</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#期间" class="sidebar-link">期间</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#打印自定协议" class="sidebar-link">打印自定协议</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#注册别名" class="sidebar-link">注册别名</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#bs登录错误" class="sidebar-link">bs登录错误</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#权限设置" class="sidebar-link">权限设置</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#直接往maketable插入表-生成画面高级设置触发字段不起作用" class="sidebar-link">直接往maketable插入表,生成画面高级设置触发字段不起作用</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#系统登录提示myserver加载失败" class="sidebar-link">系统登录提示myserver加载失败</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#如果筛选查询不起作用" class="sidebar-link">如果筛选查询不起作用</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#凭证定义项目" class="sidebar-link">凭证定义项目</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#登录表" class="sidebar-link">登录表</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#如果bs端有图片的报表无法工作" class="sidebar-link">如果bs端有图片的报表无法工作</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#app权限认证" class="sidebar-link">app权限认证</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#我看了一些账套，在高级设置中，写检查条件都喜欢这么写" class="sidebar-link">我看了一些账套，在高级设置中，写检查条件都喜欢这么写</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/fesion.html#结账" class="sidebar-link">结账</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>俱进</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/jujin.html" class="sidebar-link">俱进</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>天力弹簧</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/tianli.html" class="sidebar-link">app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/tianli.html#app" class="sidebar-link">app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/tianli.html#ylpapp-精工云mes" class="sidebar-link">YLPAPP 精工云MES</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SQL参考</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/sql.html" class="active sidebar-link">取年月日</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#更新行号" class="sidebar-link">更新行号</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#md5加密" class="sidebar-link">md5加密</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#字符串根据点进行分割" class="sidebar-link">字符串根据点进行分割</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#小计" class="sidebar-link">小计</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#left-join-right-join-inner-join-区别" class="sidebar-link">left join right join inner join 区别</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#当-identity-insert-设置为-off-时，不能为表中的标识列插入显式值" class="sidebar-link">当 IDENTITY_INSERT 设置为 OFF 时，不能为表中的标识列插入显式值</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#查询重复记录" class="sidebar-link">查询重复记录</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#sql执行时间" class="sidebar-link">sql执行时间</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#返回本年第几周" class="sidebar-link">返回本年第几周</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#正则" class="sidebar-link">正则</a></li></ul></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#删除数据库" class="sidebar-link">删除数据库</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#语句耗用时间" class="sidebar-link">语句耗用时间</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#返回错误" class="sidebar-link">返回错误</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/sql.html#复制表结构" class="sidebar-link">复制表结构</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Flutter</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leyuan/zh/inside/flutter.html" class="sidebar-link">Flutter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/flutter.html#column" class="sidebar-link">Column</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/flutter.html#button" class="sidebar-link">Button</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/flutter.html#router" class="sidebar-link">Router</a></li><li class="sidebar-sub-header"><a href="/leyuan/zh/inside/flutter.html#methodchannel-原生通信" class="sidebar-link">MethodChannel 原生通信</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="取年月日"><a href="#取年月日" aria-hidden="true" class="header-anchor">#</a> 取年月日</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span>

<span class="token comment">-- 取年</span>
<span class="token keyword">select</span> <span class="token keyword">year</span><span class="token punctuation">(</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">-- 取月</span>
<span class="token keyword">select</span> <span class="token keyword">month</span><span class="token punctuation">(</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><h1 id="xmlhttprequest"><a href="#xmlhttprequest" aria-hidden="true" class="header-anchor">#</a> XMLHttpRequest</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> QUOTED_IDENTIFIER <span class="token keyword">ON</span>
<span class="token keyword">SET</span> ANSI_NULLS <span class="token keyword">ON</span>
GO
<span class="token comment">/**
存储过程发起URL请求

启用 Ole Automation Procedures 选项
exec sp_configure 'show advanced options',1;
go
reconfigure;
go
sp_configure 'Ole Automation Procedures',1;
go
reconfigure;
go
*/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROC</span> P_Url_SendRequest
    <span class="token punctuation">(</span>
      <span class="token variable">@Url</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">,</span>
      <span class="token variable">@PostData</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">,</span>
      <span class="token variable">@ResponseText</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">''</span> OUTPUT
    <span class="token punctuation">)</span>
<span class="token keyword">AS</span>
    <span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span> 


    <span class="token keyword">DECLARE</span> <span class="token variable">@ServiceUrl</span> <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> 
    <span class="token keyword">DECLARE</span> <span class="token variable">@UrlAddress</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
        <span class="token variable">@ErrMsg</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>


    <span class="token keyword">SET</span> <span class="token variable">@ServiceUrl</span> <span class="token operator">=</span> <span class="token variable">@Url</span> 

    <span class="token keyword">PRINT</span> <span class="token variable">@ServiceUrl</span>

    <span class="token keyword">DECLARE</span> <span class="token variable">@Object</span> <span class="token keyword">AS</span> <span class="token keyword">INT</span> <span class="token punctuation">,</span>
        <span class="token variable">@status</span> <span class="token keyword">INT</span> <span class="token punctuation">,</span>
        <span class="token variable">@returnText</span> <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
        <span class="token variable">@HttpStatus</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
        <span class="token variable">@HttpMethod</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'get'</span>

    <span class="token keyword">IF</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@PostData</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token string">''</span>
        <span class="token keyword">SET</span> <span class="token variable">@HttpMethod</span> <span class="token operator">=</span> <span class="token string">'post'</span>

<span class="token comment">/*初始化对*/</span>                   
    <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sp_OACreate <span class="token string">'Msxml2.ServerXMLHTTP.3.0'</span><span class="token punctuation">,</span> <span class="token variable">@Object</span> <span class="token keyword">OUT</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>  
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span>
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'初始化对象失败，'</span> <span class="token operator">+</span> <span class="token variable">@ErrMsg</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">1</span>
        <span class="token keyword">END</span>  
<span class="token comment">/*创建链接*/</span>  
    <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sp_OAMethod <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token variable">@HttpMethod</span><span class="token punctuation">,</span> <span class="token variable">@ServiceUrl</span><span class="token punctuation">,</span>
        <span class="token string">'false'</span>
    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>  
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span>
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'创建连接失败，'</span> <span class="token operator">+</span> <span class="token variable">@ErrMsg</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">2</span>
        <span class="token keyword">END</span>  

    <span class="token keyword">SELECT</span>  <span class="token variable">@HttpMethod</span>

    <span class="token keyword">IF</span> <span class="token variable">@HttpMethod</span> <span class="token operator">=</span> <span class="token string">'post'</span>
        <span class="token keyword">BEGIN</span>
            <span class="token comment">--EXEC @status = sp_OAMethod @Object, 'setRequestHeader',</span>
            <span class="token comment">--    'Content-Type', 'application/x-www-form-urlencoded'   </span>

            <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sys<span class="token punctuation">.</span>sp_OAMethod <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token string">'setRequestHeader'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
                <span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span>
    <span class="token keyword">ELSE</span>
        <span class="token keyword">BEGIN</span>

            <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sp_OAMethod <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token string">'setRequestHeader'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
                <span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/xml; charset=gb2312'</span>
            <span class="token keyword">PRINT</span> <span class="token variable">@status</span>
        <span class="token keyword">END</span>


    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>  
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span>

            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'设置RequestHeader属性失败，'</span> <span class="token operator">+</span> <span class="token variable">@ErrMsg</span>
                <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">2</span>
        <span class="token keyword">END</span>  

    <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sp_OAMethod <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token variable">@PostData</span>
    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>  
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span> 
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'发送请求头失败，'</span> <span class="token operator">+</span> <span class="token variable">@ErrMsg</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">3</span>
        <span class="token keyword">END</span> 


    <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sys<span class="token punctuation">.</span>sp_OAGetProperty <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token string">'Status'</span><span class="token punctuation">,</span> <span class="token variable">@HttpStatus</span> <span class="token keyword">OUT</span><span class="token punctuation">;</span>

    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span> 
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'读取[Status]属性值失败，'</span> <span class="token operator">+</span> <span class="token variable">@ErrMsg</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span>
                                                              <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">3</span>

        <span class="token keyword">END</span>

    <span class="token keyword">IF</span> <span class="token variable">@HttpStatus</span> <span class="token operator">&lt;&gt;</span> <span class="token number">200</span>
        <span class="token keyword">BEGIN</span>
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'访问错误，http状态代码，'</span> <span class="token operator">+</span> <span class="token variable">@HttpStatus</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">RETURN</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span>


    <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sp_OAMethod <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token string">'responseText'</span><span class="token punctuation">,</span> <span class="token variable">@ResponseText</span> OUTPUT
    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>  
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span>
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'获取回复报文失败，'</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">4</span>
        <span class="token keyword">END</span> 

    <span class="token keyword">EXEC</span> <span class="token variable">@status</span> <span class="token operator">=</span> sp_OADestroy <span class="token variable">@Object</span>
    <span class="token keyword">IF</span> <span class="token variable">@status</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
        <span class="token keyword">BEGIN</span>  
            <span class="token keyword">EXEC</span> sp_OAGetErrorInfo <span class="token variable">@Object</span><span class="token punctuation">,</span> <span class="token variable">@ErrMsg</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@returnText</span> <span class="token keyword">OUT</span>
            <span class="token keyword">SET</span> <span class="token variable">@ErrMsg</span> <span class="token operator">=</span> <span class="token string">'释放资源对象，'</span> <span class="token operator">+</span> <span class="token variable">@ErrMsg</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span><span class="token variable">@returnText</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@ErrMsg</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           
            <span class="token keyword">RETURN</span> <span class="token number">5</span>
        <span class="token keyword">END</span>


    <span class="token keyword">RETURN</span> <span class="token number">0</span>

GO
</code></pre></div><h1 id="sql-server-clr"><a href="#sql-server-clr" aria-hidden="true" class="header-anchor">#</a> SQL Server CLR</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">--开启所有服务器配置</span>
sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> override 
GO 
<span class="token comment">--开启 CLR</span>
sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> override 
GO
</code></pre></div><h1 id="xp-cmdshell运行cmd命令"><a href="#xp-cmdshell运行cmd命令" aria-hidden="true" class="header-anchor">#</a> xp_cmdshell运行cmd命令</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- 启用</span>
<span class="token keyword">USE</span> master
GO
<span class="token keyword">RECONFIGURE</span> <span class="token comment">--先执行一次刷新，处理上次的配置</span>
GO
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token comment">--启用xp_cmdshell的高级配置</span>
GO
<span class="token keyword">RECONFIGURE</span> <span class="token comment">--刷新配置</span>
GO
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span><span class="token number">1</span>  <span class="token comment">--打开xp_cmdshell,可以调用SQL系统之外的命令</span>
GO

<span class="token keyword">RECONFIGURE</span>
GO
<span class="token comment">--使用xp_cmdshell在D盘创建一个myfile 文件夹</span>
<span class="token keyword">EXEC</span> xp_cmdshell <span class="token string">'mkdir d:\myfile'</span><span class="token punctuation">,</span>no_output <span class="token comment">--[no_output]表示是否输出信息</span>
GO

<span class="token comment">--关闭</span>
<span class="token keyword">USE</span> master 
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span> 
<span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE 
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">0</span> 
<span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE 
<span class="token keyword">EXEC</span> sp_configure   <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE 

</code></pre></div><h1 id="表创建"><a href="#表创建" aria-hidden="true" class="header-anchor">#</a> 表创建</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysobjects <span class="token keyword">where</span> id <span class="token operator">=</span> object_id<span class="token punctuation">(</span><span class="token string">'mytab'</span><span class="token punctuation">)</span> 
<span class="token operator">and</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'IsUserTable'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">create</span> <span class="token keyword">table</span>  mytab
<span class="token punctuation">(</span>
   id <span class="token keyword">int</span><span class="token punctuation">,</span>
   age <span class="token keyword">int</span> <span class="token punctuation">,</span>
   name <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>age<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
</code></pre></div><h1 id="列创建"><a href="#列创建" aria-hidden="true" class="header-anchor">#</a> 列创建</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> syscolumns <span class="token keyword">where</span> id<span class="token operator">=</span>object_id<span class="token punctuation">(</span><span class="token string">'mytab'</span><span class="token punctuation">)</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'columnname'</span><span class="token punctuation">)</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token punctuation">[</span>mytab<span class="token punctuation">]</span> <span class="token keyword">add</span> columnname nvarchar<span class="token punctuation">(</span>max<span class="token punctuation">)</span>
</code></pre></div><h1 id="某天数据"><a href="#某天数据" aria-hidden="true" class="header-anchor">#</a> 某天数据</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code>今天的所有数据：
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> DateDiff<span class="token punctuation">(</span>dd<span class="token punctuation">,</span><span class="token keyword">datetime</span>类型字段<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">SELECT</span>  <span class="token operator">*</span> <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> <span class="token keyword">CONVERT</span> <span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>日期字段名<span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> <span class="token keyword">DAY</span><span class="token punctuation">(</span>日期字段名<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">DAY</span><span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

昨天的所有数据：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> DateDiff<span class="token punctuation">(</span>dd<span class="token punctuation">,</span><span class="token keyword">datetime</span>类型字段<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token number">7</span>天内的所有数据：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> DateDiff<span class="token punctuation">(</span>dd<span class="token punctuation">,</span><span class="token keyword">datetime</span>类型字段<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">7</span>

<span class="token number">30</span>天内的所有数据：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> DateDiff<span class="token punctuation">(</span>dd<span class="token punctuation">,</span><span class="token keyword">datetime</span>类型字段<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">30</span>

本月的所有数据：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> DateDiff<span class="token punctuation">(</span>mm<span class="token punctuation">,</span><span class="token keyword">datetime</span>类型字段<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span>

本年的所有数据：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> DateDiff<span class="token punctuation">(</span>yy<span class="token punctuation">,</span><span class="token keyword">datetime</span>类型字段<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span>

查询今天是今年的第几天： <span class="token keyword">select</span> datepart<span class="token punctuation">(</span>dayofyear<span class="token punctuation">,</span>getDate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

查询今天是本月的第几天：<span class="token number">1.</span> <span class="token keyword">select</span> datepart<span class="token punctuation">(</span>dd<span class="token punctuation">,</span> getDate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                     <span class="token number">2.</span><span class="token keyword">select</span> <span class="token keyword">day</span><span class="token punctuation">(</span>getDate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

查询本周的星期一日期是多少 （注意：指定日期不能是周日，如果是周日会计算到下周一去。所以如果是周日要减一天） <span class="token keyword">SELECT</span> DATEADD<span class="token punctuation">(</span>wk<span class="token punctuation">,</span>DATEDIFF<span class="token punctuation">(</span>wk<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

查询昨天日期：<span class="token keyword">select</span> <span class="token keyword">convert</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">,</span>dateadd<span class="token punctuation">(</span>DD<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">)</span>  <span class="token comment">//111是样式号，（100-114）</span>

查询本月第一天日期：<span class="token keyword">Select</span> DATEADD<span class="token punctuation">(</span>mm<span class="token punctuation">,</span> DATEDIFF<span class="token punctuation">(</span>mm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> firstday

查询本月最后一天日期：<span class="token keyword">Select</span> dateadd<span class="token punctuation">(</span>ms<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span>DATEADD<span class="token punctuation">(</span>mm<span class="token punctuation">,</span> DATEDIFF<span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lastday      <span class="token comment">//修改-3的值会有相应的变化</span>

本月有多少天：<span class="token keyword">select</span> datepart<span class="token punctuation">(</span>dd<span class="token punctuation">,</span>dateadd<span class="token punctuation">(</span>dd<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>dateadd<span class="token punctuation">(</span>mm<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>cast<span class="token punctuation">(</span><span class="token punctuation">(</span>cast<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">(</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'-'</span><span class="token operator">+</span>cast<span class="token punctuation">(</span><span class="token keyword">month</span><span class="token punctuation">(</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'-01'</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">datetime</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

求两个时间段相差几天：<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token string">'2012/8/1'</span><span class="token punctuation">,</span><span class="token string">'2012/8/20'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> daysum

在指定的日期上±N天：<span class="token keyword">select</span> <span class="token keyword">convert</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">,</span>dateadd<span class="token punctuation">(</span>dd<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2012/8/20'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">)</span> <span class="token keyword">as</span> riqi    <span class="token comment">//输出2012/8/21</span>

在指定的日期上±N分钟：<span class="token keyword">select</span> dateadd<span class="token punctuation">(</span>mi<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//查询当前时间15分钟之前的日期</span>
</code></pre></div><h1 id="行号"><a href="#行号" aria-hidden="true" class="header-anchor">#</a> 行号</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> dcno<span class="token punctuation">)</span> <span class="token keyword">from</span> dl_yc_report

<span class="token keyword">IDENTITY</span><span class="token punctuation">(</span><span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="更新行号"><a href="#更新行号" aria-hidden="true" class="header-anchor">#</a> 更新行号</h2> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> x
<span class="token keyword">SET</span> x<span class="token punctuation">.</span>CODE_DEST <span class="token operator">=</span> x<span class="token punctuation">.</span>New_CODE_DEST
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
      <span class="token keyword">SELECT</span> CODE_DEST<span class="token punctuation">,</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>RS_NOM<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> New_CODE_DEST
      <span class="token keyword">FROM</span> DESTINATAIRE_TEMP
      <span class="token punctuation">)</span> x
<span class="token comment">--</span>
https:<span class="token comment">//stackoverflow.com/questions/13648898/sql-update-with-row-number    </span>
</code></pre></div><h1 id="左右空格"><a href="#左右空格" aria-hidden="true" class="header-anchor">#</a> 左右空格</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> ltrim<span class="token punctuation">(</span>rtrim<span class="token punctuation">(</span><span class="token string">'1,2,3,4,5,6,7,8,9'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="返回指定字符下标"><a href="#返回指定字符下标" aria-hidden="true" class="header-anchor">#</a> 返回指定字符下标</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- 2</span>
<span class="token keyword">select</span> charindex<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'1,2,3,4,5,6,7,8,9'</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="从左取数"><a href="#从左取数" aria-hidden="true" class="header-anchor">#</a> 从左取数</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- '1,2'</span>
<span class="token keyword">select</span> <span class="token keyword">left</span><span class="token punctuation">(</span><span class="token string">'1,2,3,4,5,6,7,8,9'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="删除自定范围字符"><a href="#删除自定范围字符" aria-hidden="true" class="header-anchor">#</a> 删除自定范围字符</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- 2,3,4,5,6,7,8,9</span>
<span class="token keyword">select</span> stuff<span class="token punctuation">(</span><span class="token string">'1,2,3,4,5,6,7,8,9'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="base64编码解码"><a href="#base64编码解码" aria-hidden="true" class="header-anchor">#</a> base64编码解码</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">--BASE64编码</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>FnBase64Encode<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">@src</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span>
　　<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
<span class="token keyword">as</span>
<span class="token keyword">begin</span>
　　<span class="token keyword">declare</span> <span class="token variable">@bin</span> <span class="token keyword">varbinary</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
　　<span class="token keyword">set</span> <span class="token variable">@bin</span><span class="token operator">=</span><span class="token keyword">Convert</span><span class="token punctuation">(</span><span class="token keyword">varbinary</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@src</span><span class="token punctuation">)</span>
　　<span class="token keyword">return</span> cast<span class="token punctuation">(</span>N<span class="token string">''</span> <span class="token keyword">as</span> xml<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'xs:base64Binary(xs:hexBinary(sql:variable(&quot;@bin&quot;)))'</span><span class="token punctuation">,</span> <span class="token string">'varchar(max)'</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
GO

 

<span class="token comment">--BASE64解码</span>

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>FnBase64Decode<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">@64</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span>
　　<span class="token keyword">RETURNs</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
　　<span class="token keyword">declare</span> <span class="token variable">@bin</span> <span class="token keyword">varbinary</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
　　<span class="token keyword">set</span> <span class="token variable">@bin</span><span class="token operator">=</span>cast<span class="token punctuation">(</span>N<span class="token string">''</span> <span class="token keyword">as</span> xml<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'xs:base64Binary(sql:variable(&quot;@64&quot;))'</span><span class="token punctuation">,</span> <span class="token string">'varbinary(max)'</span><span class="token punctuation">)</span>
　　<span class="token keyword">return</span> <span class="token keyword">Convert</span><span class="token punctuation">(</span><span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@bin</span><span class="token punctuation">)</span>
<span class="token keyword">END</span>
GO
</code></pre></div><h1 id="select-失败-因为下列-set-选项的设置不正确-arithabort-。请确保-set-选项正确"><a href="#select-失败-因为下列-set-选项的设置不正确-arithabort-。请确保-set-选项正确" aria-hidden="true" class="header-anchor">#</a> SELECT 失败,因为下列 SET 选项的设置不正确: 'ARITHABORT'。请确保 SET 选项正确</h1> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 1</span>
<span class="token keyword">Set</span> ARITHABORT <span class="token keyword">ON</span>
GO
<span class="token comment">-- 2</span>
<span class="token keyword">exec</span> sp_dboption <span class="token string">'yourdb'</span><span class="token punctuation">,</span><span class="token string">'ARITHABORT'</span><span class="token punctuation">,</span><span class="token string">'true'</span>
<span class="token comment">-- 3</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> yourdb 
<span class="token keyword">SET</span> ARITHABORT <span class="token keyword">ON</span>
</code></pre></div><h1 id="字符串截取"><a href="#字符串截取" aria-hidden="true" class="header-anchor">#</a> 字符串截取</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code>substring<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="回车-换行"><a href="#回车-换行" aria-hidden="true" class="header-anchor">#</a> 回车 换行</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">--1： 回车符</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span>detail<span class="token punctuation">,</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string">'&lt;br&gt;'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 显示替换后的内容 <span class="token keyword">FROM</span> loginfo
<span class="token comment">--2：换行符</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span>detail<span class="token punctuation">,</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'&lt;br&gt;'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 显示替换后的内容 <span class="token keyword">FROM</span> loginfo
<span class="token comment">--3：回车换行符</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span>detail<span class="token punctuation">,</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'&lt;br&gt;'</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="影响行数"><a href="#影响行数" aria-hidden="true" class="header-anchor">#</a> 影响行数</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> @<span class="token variable">@ROWCOUNT</span>
</code></pre></div><h1 id="临时表、表变量"><a href="#临时表、表变量" aria-hidden="true" class="header-anchor">#</a> 临时表、表变量</h1> <p>https://www.cnblogs.com/xiaozhi1236/p/5895935.html</p> <h1 id="行转列、列转行"><a href="#行转列、列转行" aria-hidden="true" class="header-anchor">#</a> 行转列、列转行</h1> <p>https://www.cnblogs.com/Brambling/p/6759992.html?utm_source=itdadao&amp;utm_medium=referral</p> <h1 id="每周以星期几开始，周一是-1-，周天是-7-一般来说，此默认值与当前所用语言相关，中文默认为7-既周天"><a href="#每周以星期几开始，周一是-1-，周天是-7-一般来说，此默认值与当前所用语言相关，中文默认为7-既周天" aria-hidden="true" class="header-anchor">#</a> 每周以星期几开始，周一是 1 ，周天是 7 一般来说，此默认值与当前所用语言相关，中文默认为7  既周天</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code>@<span class="token variable">@DATEFIRST</span> 
<span class="token punctuation">`</span><span class="token punctuation">`</span>

<span class="token comment"># 查询当前语言   </span>
<span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token keyword">SQL</span>
<span class="token keyword">select</span>    @<span class="token variable">@LANGUAGE</span>
</code></pre></div><p>#查询查看语言设置信息</p> <div class="language-SQL extra-class"><pre class="language-sql"><code>sp_helplanguage
</code></pre></div><h1 id="指定一周中的第一天"><a href="#指定一周中的第一天" aria-hidden="true" class="header-anchor">#</a> 指定一周中的第一天</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> DATEFIRST <span class="token number">1</span>
<span class="token keyword">SELECT</span> @<span class="token variable">@DATEFIRST</span>
</code></pre></div><h1 id="查询当前是周几"><a href="#查询当前是周几" aria-hidden="true" class="header-anchor">#</a> 查询当前是周几</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span>        DATEFIRST <span class="token number">1</span>
<span class="token keyword">SELECT</span>    @<span class="token variable">@DATEFIRST</span> <span class="token string">'startday'</span><span class="token punctuation">,</span>datepart<span class="token punctuation">(</span>dw<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token string">'weekday'</span>

<span class="token keyword">set</span> datefirst <span class="token number">1</span>
<span class="token keyword">select</span> datepart<span class="token punctuation">(</span>weekday<span class="token punctuation">,</span> getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">set</span> <span class="token keyword">language</span> N<span class="token string">'English'</span>
<span class="token keyword">select</span> datename<span class="token punctuation">(</span>weekday<span class="token punctuation">,</span> getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">set</span> <span class="token keyword">language</span> N<span class="token string">'Simplified Chinese'</span>
<span class="token keyword">select</span> datename<span class="token punctuation">(</span>weekday<span class="token punctuation">,</span> getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">`</span><span class="token punctuation">`</span>

<span class="token comment"># 去重</span>
<span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token keyword">SQL</span>
<span class="token keyword">distinct</span>
</code></pre></div><h1 id="修改表"><a href="#修改表" aria-hidden="true" class="header-anchor">#</a> 修改表</h1> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- 重命名表：</span>
<span class="token keyword">EXEC</span> sp_rename <span class="token string">'oldname'</span><span class="token punctuation">,</span><span class="token string">'newname'</span>
<span class="token comment">-- 修改列属性：</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 学生信息
<span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> 姓名 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token comment">-- 添加列：</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">'学生信息'</span>
<span class="token keyword">ADD</span> <span class="token string">'家庭住址'</span> nvarchar<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span>
<span class="token comment">-- 删除列：</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">'学生信息'</span>
<span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> <span class="token string">'家庭住址'</span>
<span class="token comment">-- 修改列名：</span>
<span class="token keyword">exec</span> sp_rename <span class="token string">'表名.[字段原名]'</span><span class="token punctuation">,</span><span class="token string">'字段新名'</span><span class="token punctuation">,</span><span class="token string">'column'</span>
</code></pre></div><p>#复制表：</p> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- 复制整张表：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> new_table <span class="token keyword">from</span> old_table

<span class="token comment">-- 复制表结构：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> new_table <span class="token keyword">from</span> old_table <span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span>

<span class="token comment">-- 复制表内容：</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> new_tab <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> old_table

<span class="token comment">-- 修改identity列 自增列不能直接修改，必须将原有ID列删除，然后重新添加一列具有identity属性的ID字段。比如你要修改的字段名为ID：</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token string">'表名'</span> <span class="token keyword">drop</span> <span class="token keyword">column</span> ID
<span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token string">'表名'</span> <span class="token keyword">add</span> ID <span class="token keyword">int</span> <span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="md5加密"><a href="#md5加密" aria-hidden="true" class="header-anchor">#</a> md5加密</h2> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- HEX 16进制</span>
<span class="token keyword">select</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">VARBINARY</span><span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'huo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">--去掉“0x”转换为小写值就完全与MD5值吻合了，在此需要用另一个函数（sys.fn_sqlvarbasetostr）把varbinary的值转换为varchar类型的</span>
<span class="token keyword">select</span> substring<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>fn_sqlvarbasetostr<span class="token punctuation">(</span>HashBytes<span class="token punctuation">(</span><span class="token string">'MD5'</span><span class="token punctuation">,</span><span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="字符串根据点进行分割"><a href="#字符串根据点进行分割" aria-hidden="true" class="header-anchor">#</a> 字符串根据点进行分割</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> PARSENAME<span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span><span class="token string">':'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dbo<span class="token punctuation">.</span>fu_listToTb<span class="token punctuation">(</span><span class="token string">'10:D2019080000080,2:D20190800000581'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="小计"><a href="#小计" aria-hidden="true" class="header-anchor">#</a> 小计</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>SalesOrg<span class="token punctuation">]</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> SQL_Latin1_General_CP850_BIN2 <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SalesGroup<span class="token punctuation">]</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> SQL_Latin1_General_CP850_BIN2 <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>DocumentType<span class="token punctuation">]</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> SQL_Latin1_General_CP850_BIN2 <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>DocumentName<span class="token punctuation">]</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> SQL_Latin1_General_CP850_BIN2 <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>CSName<span class="token punctuation">]</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> SQL_Latin1_General_CP850_BIN2 <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>Qty<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">int</span><span class="token punctuation">]</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>Amount<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">numeric</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token punctuation">[</span><span class="token keyword">PRIMARY</span><span class="token punctuation">]</span>
复制代码


<span class="token keyword">select</span> <span class="token keyword">case</span> grouping<span class="token punctuation">(</span>DocumentType<span class="token punctuation">)</span>
           <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'Total'</span>
           <span class="token keyword">when</span> <span class="token number">0</span> <span class="token keyword">then</span>
                <span class="token keyword">case</span> grouping<span class="token punctuation">(</span>SalesOrg<span class="token punctuation">)</span>
                   <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> DocumentType <span class="token operator">+</span> <span class="token string">' SubTotal'</span>
                   <span class="token keyword">when</span> <span class="token number">0</span> <span class="token keyword">then</span> DocumentType
                <span class="token keyword">end</span>
         <span class="token keyword">end</span> DocumentType<span class="token punctuation">,</span>
         SalesOrg<span class="token punctuation">,</span>SalesGroup<span class="token punctuation">,</span>DocumentName<span class="token punctuation">,</span>CSName<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>Qty<span class="token punctuation">)</span> qty<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>Amount<span class="token punctuation">)</span> Amt
   <span class="token keyword">from</span> <span class="token punctuation">[</span>A<span class="token punctuation">]</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> DocumentType<span class="token punctuation">,</span> SalesOrg<span class="token punctuation">,</span>SalesGroup<span class="token punctuation">,</span>DocumentName<span class="token punctuation">,</span>CSName <span class="token keyword">with rollup</span>
<span class="token keyword">having</span> grouping<span class="token punctuation">(</span>SalesOrg<span class="token punctuation">)</span> <span class="token operator">+</span> grouping<span class="token punctuation">(</span>SalesGroup<span class="token punctuation">)</span> <span class="token operator">+</span> grouping<span class="token punctuation">(</span>DocumentType<span class="token punctuation">)</span>
<span class="token operator">+</span>grouping<span class="token punctuation">(</span>DocumentName<span class="token punctuation">)</span><span class="token operator">+</span>grouping<span class="token punctuation">(</span>CSName<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token operator">or</span> grouping <span class="token punctuation">(</span>SalesOrg<span class="token punctuation">)</span> <span class="token operator">+</span> grouping<span class="token punctuation">(</span>SalesGroup<span class="token punctuation">)</span><span class="token operator">+</span>grouping<span class="token punctuation">(</span>DocumentName<span class="token punctuation">)</span><span class="token operator">+</span>grouping<span class="token punctuation">(</span>CSName<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span>
</code></pre></div><h3 id="left-join-right-join-inner-join-区别"><a href="#left-join-right-join-inner-join-区别" aria-hidden="true" class="header-anchor">#</a> left join right join inner join 区别</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token comment">-- left join(左联接) 返回包括左表中的所有记录和右表中联结字段相等的记录 </span>
<span class="token comment">-- right join(右联接) 返回包括右表中的所有记录和左表中联结字段相等的记录</span>
<span class="token comment">-- inner join(等值连接) 只返回两个表中联结字段相等的行</span>
<span class="token punctuation">`</span><span class="token punctuation">`</span>

<span class="token comment">### in 集合筛选必须过滤掉 NULL</span>
<span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token keyword">SQL</span>
<span class="token keyword">LEFT</span><span class="token punctuation">(</span> a3<span class="token punctuation">.</span>my_keyno<span class="token punctuation">,</span><span class="token function">LEN</span><span class="token punctuation">(</span>a3<span class="token punctuation">.</span>inno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>a3<span class="token punctuation">.</span>mcode  <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> inoutno<span class="token operator">+</span>mcode  <span class="token keyword">from</span> py_invoicelist <span class="token keyword">where</span> isnull<span class="token punctuation">(</span>inoutno<span class="token operator">+</span>mcode<span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token string">''</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="当-identity-insert-设置为-off-时，不能为表中的标识列插入显式值"><a href="#当-identity-insert-设置为-off-时，不能为表中的标识列插入显式值" aria-hidden="true" class="header-anchor">#</a> 当 IDENTITY_INSERT 设置为 OFF 时，不能为表中的标识列插入显式值</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> <span class="token keyword">identity_insert</span> OrderList <span class="token keyword">ON</span>
</code></pre></div><h3 id="查询重复记录"><a href="#查询重复记录" aria-hidden="true" class="header-anchor">#</a> 查询重复记录</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> PF_MES_PG_QRCODEINFO <span class="token keyword">WHERE</span> sn <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token keyword">select</span>  sn <span class="token keyword">from</span>  PF_MES_PG_QRCODEINFO <span class="token keyword">group</span> <span class="token keyword">by</span>  sn <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span> sn<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span>）
</code></pre></div><h3 id="sql执行时间"><a href="#sql执行时间" aria-hidden="true" class="header-anchor">#</a> sql执行时间</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">declare</span> <span class="token variable">@d</span> <span class="token keyword">datetime</span>
<span class="token keyword">set</span> <span class="token variable">@d</span><span class="token operator">=</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> PF_MES_ORDERDETAIL
<span class="token keyword">select</span> cast<span class="token punctuation">(</span>datediff<span class="token punctuation">(</span>ms<span class="token punctuation">,</span><span class="token variable">@d</span><span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'ms'</span>
</code></pre></div><h3 id="返回本年第几周"><a href="#返回本年第几周" aria-hidden="true" class="header-anchor">#</a> 返回本年第几周</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> datepart<span class="token punctuation">(</span>week<span class="token punctuation">,</span>getdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="正则"><a href="#正则" aria-hidden="true" class="header-anchor">#</a> 正则</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">USE</span> <span class="token punctuation">[</span>MES<span class="token punctuation">]</span>
GO
<span class="token comment">/****** Object:  UserDefinedFunction [dbo].[VBARegexMatch]    Script Date: 2019/10/24 12:18:57 ******/</span>
<span class="token keyword">SET</span> ANSI_NULLS <span class="token keyword">ON</span>
GO
<span class="token keyword">SET</span> QUOTED_IDENTIFIER <span class="token keyword">ON</span>
GO
 <span class="token comment">--开始创建正则替换函数  </span>
   <span class="token keyword">ALTER</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>VBARegexMatch<span class="token punctuation">]</span>  
 <span class="token punctuation">(</span>  
     <span class="token variable">@string</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">--要检查的字符串  </span>
     <span class="token variable">@pattern</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">--正则pattern  </span>
     <span class="token variable">@IgnoreCase</span> <span class="token keyword">INT</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--0区分大小写 1不区分大小写  </span>
 <span class="token punctuation">)</span>  
 <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>  
 <span class="token keyword">AS</span>   
 <span class="token keyword">BEGIN</span>  
     <span class="token keyword">DECLARE</span> <span class="token variable">@objRegex</span> <span class="token keyword">INT</span><span class="token punctuation">,</span> <span class="token variable">@retstr</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>  
     <span class="token comment">--创建对象  </span>
     <span class="token keyword">EXEC</span> sp_OACreate <span class="token string">'VBScript.RegExp'</span><span class="token punctuation">,</span> <span class="token variable">@objRegex</span> <span class="token keyword">OUT</span>  
     <span class="token comment">--设置属性  </span>
     <span class="token keyword">EXEC</span> sp_OASetProperty <span class="token variable">@objRegex</span><span class="token punctuation">,</span> <span class="token string">'Pattern'</span><span class="token punctuation">,</span> <span class="token variable">@pattern</span>  
     <span class="token keyword">EXEC</span> sp_OASetProperty <span class="token variable">@objRegex</span><span class="token punctuation">,</span> <span class="token string">'IgnoreCase'</span><span class="token punctuation">,</span> <span class="token variable">@IgnoreCase</span>  
     <span class="token keyword">EXEC</span> sp_OASetProperty <span class="token variable">@objRegex</span><span class="token punctuation">,</span> <span class="token string">'Global'</span><span class="token punctuation">,</span> <span class="token number">1</span>  
     <span class="token comment">--执行  </span>
     <span class="token keyword">EXEC</span> sp_OAMethod <span class="token variable">@objRegex</span><span class="token punctuation">,</span> <span class="token string">'Test'</span><span class="token punctuation">,</span> <span class="token variable">@retstr</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token variable">@string</span>
     <span class="token comment">--释放  </span>
     <span class="token keyword">EXECUTE</span> sp_OADestroy <span class="token variable">@objRegex</span>  
     <span class="token keyword">RETURN</span> <span class="token variable">@retstr</span>  
 <span class="token keyword">END</span>  
</code></pre></div><h2 id="删除数据库"><a href="#删除数据库" aria-hidden="true" class="header-anchor">#</a> 删除数据库</h2> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">database</span> TIANLIZ
</code></pre></div><h2 id="死锁"><a href="#死锁" aria-hidden="true" class="header-anchor">#</a> 死锁</h2> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">use</span> master 
go
<span class="token comment">/*
exec master..sp_who_lock 
select a.* from myerp..st_outstore a where a.ddate=myerp.dbo.ldttosdt(getdate())
select a.* from myerp..st_instore a where a.ddate=myerp.dbo.ldttosdt(getdate())
*/</span>
<span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> id <span class="token operator">=</span> object_id<span class="token punctuation">(</span>N<span class="token string">'[dbo].[sp_who_lock]'</span><span class="token punctuation">)</span> <span class="token operator">and</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> N<span class="token string">'IsProcedure'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>sp_who_lock<span class="token punctuation">]</span>
GO

<span class="token comment">--查询死锁 exec sp_who_lock </span>
<span class="token comment">--kill 2275 编号 --解锁</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> dbo<span class="token punctuation">.</span>sp_who_lock 
<span class="token keyword">as</span>
<span class="token keyword">begin</span>
<span class="token keyword">declare</span> <span class="token variable">@spid</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@bl</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
        <span class="token variable">@inttransactioncountonentry</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
        <span class="token variable">@introwcount</span>     <span class="token keyword">int</span><span class="token punctuation">,</span>
        <span class="token variable">@intcountproperties</span>    <span class="token keyword">int</span><span class="token punctuation">,</span>
        <span class="token variable">@intcounter</span>     <span class="token keyword">int</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token comment">#tmp_lock_who (id int identity(1,1),spid smallint,bl smallint)</span>

<span class="token keyword">if</span> @<span class="token variable">@error</span><span class="token operator">&lt;&gt;</span><span class="token number">0</span> <span class="token keyword">return</span> @<span class="token variable">@error</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token comment">#tmp_lock_who(spid,bl) select 0 ,blocked</span>
   <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysprocesses <span class="token keyword">where</span> blocked<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token punctuation">)</span> a 
   <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysprocesses <span class="token keyword">where</span> blocked<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token punctuation">)</span> b 
   <span class="token keyword">where</span> a<span class="token punctuation">.</span>blocked<span class="token operator">=</span>spid<span class="token punctuation">)</span>
   <span class="token keyword">union</span> <span class="token keyword">select</span> spid<span class="token punctuation">,</span>blocked <span class="token keyword">from</span> sysprocesses <span class="token keyword">where</span> blocked<span class="token operator">&gt;</span><span class="token number">0</span>

<span class="token keyword">if</span> @<span class="token variable">@error</span><span class="token operator">&lt;&gt;</span><span class="token number">0</span> <span class="token keyword">return</span> @<span class="token variable">@error</span> 

<span class="token comment">-- 找到临时表的记录数</span>
<span class="token keyword">select</span> <span class="token variable">@intcountproperties</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@intcounter</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">from</span> <span class="token comment">#tmp_lock_who</span>

<span class="token keyword">if</span> @<span class="token variable">@error</span><span class="token operator">&lt;&gt;</span><span class="token number">0</span> <span class="token keyword">return</span> @<span class="token variable">@error</span> 

<span class="token keyword">if</span> <span class="token variable">@intcountproperties</span><span class="token operator">=</span><span class="token number">0</span>
   <span class="token keyword">select</span> <span class="token string">'现在没有阻塞和死锁信息'</span> <span class="token keyword">as</span> message

<span class="token comment">-- 循环开始</span>
<span class="token keyword">while</span> <span class="token variable">@intcounter</span> <span class="token operator">&lt;=</span> <span class="token variable">@intcountproperties</span>
<span class="token keyword">begin</span>
<span class="token comment">-- 取第一条记录</span>
   <span class="token keyword">select</span> <span class="token variable">@spid</span> <span class="token operator">=</span> spid<span class="token punctuation">,</span><span class="token variable">@bl</span> <span class="token operator">=</span> bl
   <span class="token keyword">from</span> <span class="token comment">#tmp_lock_who where id = @intcounter </span>
<span class="token keyword">begin</span>
<span class="token keyword">if</span> <span class="token variable">@spid</span> <span class="token operator">=</span><span class="token number">0</span> 
     <span class="token keyword">select</span> <span class="token variable">@bl</span> <span class="token keyword">as</span> pid<span class="token punctuation">,</span><span class="token string">'引起数据库死锁的是: '</span><span class="token operator">+</span> cast<span class="token punctuation">(</span><span class="token variable">@bl</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'进程号,其执行的sql语法如下'</span> <span class="token keyword">as</span> memo
<span class="token keyword">else</span>
     <span class="token keyword">select</span> <span class="token variable">@spid</span> <span class="token keyword">as</span> pid<span class="token punctuation">,</span><span class="token string">'进程号spid：'</span><span class="token operator">+</span> cast<span class="token punctuation">(</span><span class="token variable">@spid</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">'被'</span> <span class="token operator">+</span> <span class="token string">'进程号spid：'</span><span class="token operator">+</span> cast<span class="token punctuation">(</span><span class="token variable">@bl</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'阻塞,其当前进程执行的sql语法如下'</span> <span class="token keyword">as</span> memo
<span class="token keyword">dbcc</span> inputbuffer <span class="token punctuation">(</span><span class="token variable">@bl</span> <span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 循环指针下移</span>
<span class="token keyword">set</span> <span class="token variable">@intcounter</span> <span class="token operator">=</span> <span class="token variable">@intcounter</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">end</span>


<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token comment">#tmp_lock_who</span>

<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
go
</code></pre></div><h2 id="语句耗用时间"><a href="#语句耗用时间" aria-hidden="true" class="header-anchor">#</a> 语句耗用时间</h2> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">use</span> master
go
<span class="token keyword">SELECT</span>  <span class="token keyword">top</span> <span class="token number">100</span> <span class="token punctuation">(</span> total_elapsed_time <span class="token operator">/</span> execution_count <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> N<span class="token string">'平均时间ms'</span> <span class="token punctuation">,</span>
        total_elapsed_time <span class="token operator">/</span> <span class="token number">1000</span> N<span class="token string">'总花费时间ms'</span> <span class="token punctuation">,</span>
        total_worker_time <span class="token operator">/</span> <span class="token number">1000</span> N<span class="token string">'所用的CPU总时间ms'</span> <span class="token punctuation">,</span>
        total_physical_reads N<span class="token string">'物理读取总次数'</span> <span class="token punctuation">,</span>
        total_logical_reads <span class="token operator">/</span> execution_count N<span class="token string">'每次逻辑读次数'</span> <span class="token punctuation">,</span>
        total_logical_reads N<span class="token string">'逻辑读取总次数'</span> <span class="token punctuation">,</span>
        total_logical_writes N<span class="token string">'逻辑写入总次数'</span> <span class="token punctuation">,</span>
        execution_count N<span class="token string">'执行次数'</span> <span class="token punctuation">,</span>
        SUBSTRING<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> qs<span class="token punctuation">.</span>statement_start_offset <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                  <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">CASE</span> statement_end_offset
                        <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span>
                        <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset
                      <span class="token keyword">END</span> <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> N<span class="token string">'执行语句'</span> <span class="token punctuation">,</span>
        last_execution_time N<span class="token string">'上次执行时间'</span><span class="token punctuation">,</span>              
        creation_time N<span class="token string">'语句编译时间'</span> 
<span class="token keyword">FROM</span>    sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">AS</span> qs
        <span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> st
<span class="token keyword">WHERE</span>   SUBSTRING<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> qs<span class="token punctuation">.</span>statement_start_offset <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                  <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">CASE</span> statement_end_offset
                        <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span>
                        <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset
                      <span class="token keyword">END</span> <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%fetch%'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> total_elapsed_time <span class="token operator">/</span> execution_count <span class="token keyword">DESC</span> 
<span class="token comment">--order by last_execution_time desc</span>
go

<span class="token comment">--查询语句CPU占用</span>
<span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">10</span> total_worker_time<span class="token operator">/</span>execution_count <span class="token keyword">AS</span> avg_cpu_cost<span class="token punctuation">,</span> plan_handle<span class="token punctuation">,</span> execution_count<span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> SUBSTRING<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">,</span> statement_start_offset<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> statement_end_offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token function">LEN</span><span class="token punctuation">(</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span>nvarchar<span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token keyword">ELSE</span> statement_end_offset <span class="token keyword">END</span> <span class="token operator">-</span> statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>sql_handle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> query_text <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>avg_cpu_cost<span class="token punctuation">]</span> <span class="token keyword">DESC</span>
<span class="token comment">--set statistics time on</span>
<span class="token comment">--select * from dbo.ba_cpinfo</span>
<span class="token comment">--set statistics time off</span>

<span class="token comment">--set statistics io on</span>
<span class="token comment">--select * from dbo.Product</span>
<span class="token comment">--set statistics io off</span>

<span class="token comment">--/****** 生产环境不可乱用 ******/</span>
<span class="token comment">--DBCC DROPCLEANBUFFERS; --清除缓存</span>
<span class="token comment">--SET STATISTICS IO ON; --开启IO统计</span>
<span class="token comment">--SET STATISTICS TIME ON --开启耗时</span>
<span class="token comment">--select * from ba_cpinfo a</span>
<span class="token comment">--SET STATISTICS IO OFF; --开启IO</span>
<span class="token comment">--SET STATISTICS TIME OFF --关闭耗时</span>
</code></pre></div><h2 id="返回错误"><a href="#返回错误" aria-hidden="true" class="header-anchor">#</a> 返回错误</h2> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">RAISERROR</span> <span class="token punctuation">(</span><span class="token string">'触发错!'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="复制表结构"><a href="#复制表结构" aria-hidden="true" class="header-anchor">#</a> 复制表结构</h3> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">0</span> <span class="token operator">*</span> <span class="token keyword">into</span> <span class="token comment">#xt_UserGrpLmt_all from xt_UserGrpLmt with(nolock)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/leyuan/zh/inside/tianli.html" class="prev">
          app
        </a></span> <span class="next"><a href="/leyuan/zh/inside/flutter.html">
          Flutter
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/leyuan/assets/js/app.4c451c14.js" defer></script><script src="/leyuan/assets/js/3.4ae3e493.js" defer></script><script src="/leyuan/assets/js/22.39c1fc57.js" defer></script>
  </body>
</html>
